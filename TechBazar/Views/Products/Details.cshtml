@model Product
@using TechBazar.Models
@using TechBazar.Services
@inject IMultiLanguageService TranslationService
@{
    ViewData["Title"] = await GetTranslated("Product", "Name", Model.Id) + " - TechBazaar";
}

@functions {
    private int currentLanguageId = 1; // Default to English

    public async Task<string> GetTranslated(string tableName, string columnName, long entityId)
    {
        // Get current language from cookie
        if (Context.Request.Cookies.TryGetValue("SelectedLanguage", out var langCookie) && int.TryParse(langCookie, out var langId))
        {
            currentLanguageId = langId;
        }
        return await TranslationService.GetValueAsync(tableName, columnName, entityId, currentLanguageId);
    }
}

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-controller="Products" asp-action="Index">Products</a></li>
            <li class="breadcrumb-item"><a asp-controller="Products" asp-action="Index" asp-route-categoryId="@Model.CategoryId">@await GetTranslated("Category", "Name", Model.Category!.Id)</a></li>
            <li class="breadcrumb-item active">@await GetTranslated("Product", "Name", Model.Id)</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-6">
            <img src="@Model.ImageUrl" class="img-fluid rounded" alt="@await GetTranslated("Product", "Name", Model.Id)">
        </div>
        <div class="col-md-6">
            <h1>@await GetTranslated("Product", "Name", Model.Id)</h1>
            <span class="badge bg-primary">@await GetTranslated("Category", "Name", Model.Category!.Id)</span>

            <div class="mt-3">
                <h3 class="text-success">$@Model.Price</h3>
                <p class="text-muted">
                    @if (Model.StockQuantity > 0)
                    {
                        <span class="text-success"><i class="fas fa-check-circle"></i> In Stock (@Model.StockQuantity available)</span>
                    }
                    else
                    {
                        <span class="text-danger"><i class="fas fa-times-circle"></i> Out of Stock</span>
                    }
                </p>
            </div>

            <p class="mt-3">@await GetTranslated("Product", "Description", Model.Id)</p>

            <div class="mt-4">
                @if (Model.StockQuantity > 0)
                {
                    <form asp-controller="Products" asp-action="AddToCart" method="post">
                        <input type="hidden" name="productId" value="@Model.Id" />
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="quantity" class="col-form-label">Quantity:</label>
                            </div>
                            <div class="col-auto">
                                <input type="number" class="form-control" name="quantity" value="1" min="1" max="@Model.StockQuantity" style="width: 80px;">
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-shopping-cart"></i> Add to Cart
                                </button>
                            </div>
                        </div>
                    </form>
                }
                else
                {
                    <button class="btn btn-secondary btn-lg" disabled>Out of Stock</button>
                }
            </div>

            <div class="mt-4">
                <h5>Product Details</h5>
                <ul>
                    <li>Category: @await GetTranslated("Category", "Name", Model.Category!.Id)</li>
                    <li>Added: @Model.CreatedDate.ToString("MMMM dd, yyyy")</li>
                    <li>SKU: TB-@Model.Id.ToString("D4")</li>
                </ul>
            </div>
        </div>
    </div>

    @if (ViewBag.RelatedProducts != null && ((List<Product>)ViewBag.RelatedProducts).Any())
    {
        <div class="row mt-5">
            <div class="col-12">
                <h3>Related Products</h3>
                <div class="row g-4">
                    @foreach (var relatedProduct in ViewBag.RelatedProducts)
                    {
                        <div class="col-md-3">
                            <div class="card product-card h-100">
                                <img src="@relatedProduct.ImageUrl" class="card-img-top" alt="@await GetTranslated("Product", "Name", relatedProduct.Id)" style="height: 150px; object-fit: cover;">
                                <div class="card-body">
                                    <h6 class="card-title">@await GetTranslated("Product", "Name", relatedProduct.Id)</h6>
                                    <p class="card-text text-success">$@relatedProduct.Price</p>
                                    <a asp-controller="Products" asp-action="Details" asp-route-id="@relatedProduct.Id"
                                       class="btn btn-outline-primary btn-sm">View Details</a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>
